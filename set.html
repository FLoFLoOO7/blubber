<!DOCTYPE html>
<head>
  <link rel="stylesheet" href="set.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>




<!-- HTML Teil Anfang -->


<body class="Background">
  <div id="app">
    
    
    <a href="input.html" @click="returnToMenu">
      <img class="Zahnrad" src="Zahnrad.png" alt="Return to menu">
    </a>
 
    <div class="SetName">{{ setName }}</div>

    <div class="Set">
      
      <div class="ButtonsAndCard">
        <div class="NichtErledigtCounter">{{ countNichtErledigt }}</div>
        <div class="NichtErledigtButton" @click="markAsNichtErledigt">🟥</div>

        <!-- Florian (mit Hilfe von Nicola) -->
        <div class="Karteikarte" @click="flipCard">
            <p v-if="currentCard">{{ showDefinition ? currentCard.ruckseite : currentCard.Vorderseite }}</p>
            <p v-else-if="cards.length > 0 && !currentCard && currentCountAnzahl >= countAnzahl">Set abgeschlossen!</p>
            <p v-else-if="!setId">Keine set ID</p>
            <p v-else-if="cards.length === 0 && setId && !loading">Keine Karten in diesem Set gefunden.</p>
            <p v-else>Lade Karte...</p>
        </div>

        <div class="ErledigtButton" @click="markAsErledigt">🟩</div>
        <div class="ErledigtCounter">{{ countErledigt }}</div>
      </div>

      <div class="Count">{{ currentCountAnzahl }} / {{ countAnzahl }}</div>

    </div>  
    <div class="ZurückFeld">
        <div class="ZurückButton" @click="goBackOneCard">⬅️</div>
      </div>
    </div>

    <div class="ResetButton" @click="resetAllCards">
      🔄 Reset
    </div>
  </div>


<!-- HTML Teil Ende -->




<script>
  const { createApp } = Vue // Muss sein um Vue zu verwenden, erstellt vue app
  const API_BASE_URL = 'http://127.0.0.1:5000';
  createApp({
    data() { // Data -> Beschreibt die dynamischen Informationen, unserer App
      return {
        setName: '',
        cards: [],
        currentCard: null,
        currentIndex: -1,
        showDefinition: false,
        setId: null,
        loading: true,

        countErledigt: 0,
        countNichtErledigt: 0,

        currentCountAnzahl: 0,
        countAnzahl: 0,
      }
    },

    methods: {//ChatGPT
      goBackOneCard() {

          if (this.currentIndex === 0) return;

          this.currentIndex--;

          const previousCard = this.items[this.currentIndex];

          if (previousCard.erledigt === true) {
            this.countErledigt--;
          } else if (previousCard.erledigt === false) {
            this.countNichtErledigt--;
          }

          previousCard.erledigt = false;
          this.showDefinition = false;
        },
        restartWithIncorrectCards() {
          const falsch = this.items.filter(item => item.erledigt === false);

          if (falsch.length === 0) {
            alert("Alle Karten erledigt, zum Neustarten Knopf unten rechts klicken!");
            this.items = [];
            this.currentIndex = 0;
            this.showDefinition = false;
            return;
          }

          this.items = falsch.map(item => ({ ...item }));
          this.currentIndex = 0;
          this.countErledigt = 0;
          this.countNichtErledigt = 0;
          this.showDefinition = false;
        },
        resetAllCards() {
          this.items = this.originalItems.map(card => ({
            ...card,
            erledigt: false
          }));
          // CHATGPT


          this.currentIndex = 0;
          this.countErledigt = 0;
          this.countNichtErledigt = 0;
          this.showDefinition = false;
        },
      //Florian (mit Hilfe von Nicola)
      getSetId() {
        const params = new URLSearchParams(window.location.search);
        return params.get('set_id');
      },

      async fetchSetDetails(setId) {
        if (!setId) return;
        try {
          const response = await fetch(`${API_BASE_URL}/api/sets`);
          const sets = await response.json();
          const currentSet = sets.find(s => s.ID == setId); 
          if (currentSet) {
            this.setName = currentSet.NAME;
          } else {
            this.setName = 'Set nicht gefunden'; 
          }
        } catch (error) {
          console.error(error);
          this.setName = 'Fehler beim Laden des Sets';
        }
      },

      async fetchCards(setId) {
        if (!setId) return;
        this.loading = true;
        try {
          const response = await fetch(`${API_BASE_URL}/api/cards/${setId}`);
          this.cards = await response.json();
          if (this.cards && this.cards.length > 0) {
            this.countAnzahl = this.cards.length;
            this.currentIndex = 0;
            this.updateCurrentCardAndCount();
          } else {
            this.cards = []; 
            this.countAnzahl = 0;
            this.currentCard = null;
            this.currentCountAnzahl = 0;
          }
        } catch (error) {
          console.error('Error fetching cards:', error);
          this.cards = [];
          this.countAnzahl = 0;
        } finally {
            this.loading = false;
        }
      },

      updateCurrentCardAndCount() {
        if (this.currentIndex >= 0 && this.currentIndex < this.cards.length) {
          this.currentCard = this.cards[this.currentIndex];
          this.currentCountAnzahl = this.currentIndex + 1;
          this.showDefinition = false;
        } else {
          this.currentCard = null;
        }
      },
      
      flipCard() {
        if (this.currentCard) {
          this.showDefinition = !this.showDefinition;
        }
      },

      moveToNextCard() {
        if (this.currentIndex < this.cards.length - 1) {
          this.currentIndex++;
          this.updateCurrentCardAndCount();
        } else {
          this.currentCard = null; 
          this.currentCountAnzahl = this.cards.length; 
          alert('Set abgeschlossen!\nErledigt: ' + this.countErledigt + '\nNicht Erledigt: ' + this.countNichtErledigt);
        }
      },

      async markAsErledigt() {
  if (!this.currentCard) return;

  try {
    const response = await fetch(`${API_BASE_URL}/api/erledigt`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ id: this.currentCard.id })
    });
    console.log(body)

    if (!response.ok) {
      console.error('Fehler beim Markieren als erledigt:', await response.text());
      return;
    }

    this.countErledigt++;
    this.moveToNextCard();

  } catch (error) {
    console.error('Netzwerkfehler:', error);
  }
},


//markAsErledigt() {
//       if (!this.currentCard) return;
//      this.countErledigt++;
//      this.moveToNextCard();
//    },


      markAsNichtErledigt() {
        if (!this.currentCard) return;
        this.countNichtErledigt++;
        this.moveToNextCard();
      },
      
      returnToMenu() {
        window.location.href = "input.html";
      },

      handleKeyPress(event) {
        if (event.key === 'ArrowLeft') {
          this.markAsNichtErledigt();
        } else if (event.key === 'ArrowRight') {
          this.markAsErledigt();
        } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
          event.preventDefault(); 
          this.flipCard();
        } else if (event.key === 'Escape') {
          this.returnToMenu();
        }
      },
    }, 
    
    async mounted() {
      this.setId = this.getSetId();
      if (this.setId) {
        await this.fetchSetDetails(this.setId);
        await this.fetchCards(this.setId);
      } else {
        this.setName = 'Kein Set gefunden';
        this.loading = false;
      }
      window.addEventListener('keydown', this.handleKeyPress);
    },

    beforeUnmount() {
      window.removeEventListener('keydown', this.handleKeyPress);
    }, 
  }).mount('#app')
</script>
