<head>
  <link rel="stylesheet" href="set.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body class="Background">
  <div id="app">
    <a href="input.html">
      <img class="Zahnrad" src="Zahnrad.png" alt="Return to menu">
    </a>

    <div class="SetName">{{ setName }}</div>

    <div class="Set" v-if="currentCard">
      <div class="ButtonsAndCard">
        <div class="NichtErledigtCounter">{{ countNichtErledigt }}</div>
        <div class="NichtErledigtButton" @click="markAsNichtErledigt">üü•</div>
        <div class="Karteikarte" @click="flipCard">
          <p>{{ showDefinition ? currentCard.ruckseite : currentCard.Vorderseite }}</p>
        </div>
        <div class="ErledigtButton" @click="markAsErledigt">üü©</div>
        <div class="ErledigtCounter">{{ countErledigt }}</div>
      </div>
      <div class="Count">{{ currentCountAnzahl }} / {{ countAnzahl }}</div>
      <div class="Zur√ºckButton" @click="goBackOneCard">‚¨ÖÔ∏è</div>
    </div>
  </div>

   <script>
    const { createApp } = Vue;
    const API_BASE_URL = 'http://127.0.0.1:5000';

    createApp({
      data() {
        return {
          items: [],
          currentIndex: 0,
          showDefinition: false,
          countErledigt: 0,
          countNichtErledigt: 0,
          setId: null,
          setName: '',
        };
      },
      computed: {
        currentCard() {
          return this.items[this.currentIndex] || null;
        },
        currentCountAnzahl() {
          return this.currentIndex + 1;
        },
        countAnzahl() {
          return this.items.length;
        },
      },
      methods: {
        flipCard() {
          this.showDefinition = !this.showDefinition;
        },
        markAsErledigt() {
          this.countErledigt++;
          this.items[this.currentIndex].erledigt = true;

          if (this.currentIndex < this.items.length - 1) {
            this.nextCard();
          } else {
            this.restartWithIncorrectCards();
          }
        },
        markAsNichtErledigt() {
          this.countNichtErledigt++;
          this.items[this.currentIndex].erledigt = false;

          if (this.currentIndex < this.items.length - 1) {
            this.nextCard();
          } else {
            this.restartWithIncorrectCards();
          }
        },
        nextCard() {
          this.currentIndex++;
          this.showDefinition = false;
        },
        goBackOneCard() {
          if (this.currentIndex === 0) return;

          this.currentIndex--;

          const previousCard = this.items[this.currentIndex];

          if (previousCard.erledigt === true) {
            this.countErledigt--;
          } else if (previousCard.erledigt === false) {
            this.countNichtErledigt--;
          }

          previousCard.erledigt = undefined;
          this.showDefinition = false;
        },
        restartWithIncorrectCards() {
          const falsch = this.items.filter(item => item.erledigt === false);

          if (falsch.length === 0) {
            alert("Alle Karten erledigt! üéâ");
            return;
          }

          this.items = falsch.map(item => ({ ...item }));
          this.currentIndex = 0;
          this.countErledigt = 0;
          this.countNichtErledigt = 0;
          this.showDefinition = false;
        },
        returnToMenu() {
          window.location.href = "input.html";
        },
        handleKeyPress(event) {
          if (event.key === 'ArrowLeft') {
            this.markAsNichtErledigt();
          } else if (event.key === 'ArrowRight') {
            this.markAsErledigt();
          } else if (event.key === 'ArrowUp' || event.code === 'Space') {
            event.preventDefault();
            this.flipCard();
          } else if (event.key === 'ArrowDown') {
            this.goBackOneCard();
          } else if (event.key === 'Escape') {
            this.returnToMenu();
          }
        },
        getSetIdFromUrl() {
          const params = new URLSearchParams(window.location.search);
          return params.get("set");
        },
        async fetchCards() {
          try {
            const response = await fetch(`${API_BASE_URL}/api/cards/${this.setId}`);
            const data = await response.json();
            this.items = data.map(card => ({ ...card, erledigt: undefined }));
          } catch (error) {
            console.error('Fehler beim Laden der Karten:', error);
          }
        },
        async fetchSetName() {
          try {
            const response = await fetch(`${API_BASE_URL}/api/sets`);
            const sets = await response.json();
            const currentSet = sets.find(s => s.set == this.setId);
            this.setName = currentSet ? currentSet.set_name : "Unbekanntes Set";
          } catch (error) {
            console.error("Fehler beim Laden des Set-Namens:", error);
          }
        },
      },
      async mounted() {
        window.addEventListener('keydown', this.handleKeyPress);
        this.setId = this.getSetIdFromUrl();
        await this.fetchCards();
        await this.fetchSetName();
      },
      beforeUnmount() {
        window.removeEventListener('keydown', this.handleKeyPress);
      },
    }).mount('#app');
  </script>
</body>